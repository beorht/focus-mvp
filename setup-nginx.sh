#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –±—ã—Å—Ç—Ä–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Nginx –¥–ª—è FOCUS MVP

set -e

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx –¥–ª—è FOCUS MVP..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω —Å sudo
if [ "$EUID" -ne 0 ]; then
    echo "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å sudo:"
    echo "   sudo ./setup-nginx.sh"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ Nginx —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
if ! command -v nginx &> /dev/null; then
    echo "‚ö†Ô∏è  Nginx –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∫–∞..."
    apt update
    apt install nginx -y
fi

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
echo "üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
cp nginx.conf /etc/nginx/sites-available/focus-mvp

# –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–ª–∏–Ω–∫–∞
echo "üîó –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
ln -sf /etc/nginx/sites-available/focus-mvp /etc/nginx/sites-enabled/

# –£–¥–∞–ª–µ–Ω–∏–µ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
if [ -f /etc/nginx/sites-enabled/default ]; then
    echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
    rm /etc/nginx/sites-enabled/default
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."
nginx -t

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx
echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx..."
systemctl reload nginx

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo ""
echo "‚úÖ Nginx —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
echo ""
systemctl status nginx --no-pager -l

echo ""
echo "üìä –í–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É:"
echo "   http://$(hostname -I | awk '{print $1}')"
echo ""
echo "üìñ –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: NGINX_SETUP.md"
echo ""
echo "üîê –î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ HTTPS –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
echo "   sudo certbot --nginx -d yourdomain.com"
